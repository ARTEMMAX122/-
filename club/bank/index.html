<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω—è—è –í–∞–ª—é—Ç–∞</title>
  <style>
    :root {
      --bg: #0a2e47;
      --snow: #f8fbff;
      --gold: #ffd700;
      --green: #2e8b57;
      --red: #d32f2f;
      --border: #4a6b85;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%230a2e47"/><circle cx="20" cy="25" r="1.5" fill="%23f8fbff" opacity="0.6"/><circle cx="60" cy="15" r="1" fill="%23f8fbff" opacity="0.4"/><circle cx="85" cy="60" r="1.2" fill="%23f8fbff" opacity="0.5"/></svg>');
      color: var(--snow);
      padding: 16px;
      line-height: 1.6;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 2px solid var(--gold);
      margin-bottom: 20px;
    }

    h1 {
      font-size: 2.2rem;
      color: var(--gold);
      text-shadow: 0 0 8px rgba(255,215,0,0.4);
    }

    .top-bar {
      display: flex;
      gap: 12px;
    }

    .btn {
      background: var(--green);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn:hover { background: #226b47; }

    .btn-red { background: var(--red); }
    .btn-red:hover { background: #a02525; }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .status {
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 6px;
      background: rgba(0,0,0,0.3);
    }
    .status.error { background: rgba(211, 47, 47, 0.2); color: #ffcdd2; }
    .status.success { background: rgba(46, 139, 87, 0.2); }

    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(20, 45, 65, 0.7);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--green);
      color: white;
      position: sticky;
      top: 0;
    }

    tr.highlight {
      background: rgba(255, 215, 0, 0.2);
      animation: pulse 1.5s ease-in-out;
    }

    @keyframes pulse {
      0% { background-color: rgba(255,215,0,0.1); }
      50% { background-color: rgba(255,215,0,0.4); }
      100% { background-color: rgba(255,215,0,0.1); }
    }

    .search-panel {
      margin: 20px 0;
      padding: 16px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
    }

    .search-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select, input {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.1);
      color: var(--snow);
    }

    input::placeholder { color: #aaa; }

    footer {
      margin-top: 30px;
      text-align: center;
      font-size: 0.9rem;
      color: #aaa;
    }

    @media (max-width: 600px) {
      header { flex-direction: column; gap: 10px; }
      .search-row { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω—è—è –í–∞–ª—é—Ç–∞</h1>
      <div class="top-bar">
        <a href="https://lichess.org/team/v1TwDg2i" class="btn" target="_blank">–ö–ª—É–±</a>
        <button id="btnFind" class="btn btn-red">–ù–∞–π—Ç–∏ —Å–µ–±—è</button>
      </div>
    </header>

    <div id="status" class="status"></div>

    <div id="searchPanel" class="search-panel" style="display: none;">
      <h3>üîç –ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å—å</h3>
      <div class="search-row">
        <label>–°—Ç–æ–ª–±–µ—Ü:</label>
        <select id="colSelect">
          <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
        </select>
        <label>–¢–µ–∫—Å—Ç:</label>
        <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è, —á–∏—Å–ª–æ –∏ —Ç.–¥." />
        <button id="doSearch" class="btn">–ò—Å–∫–∞—Ç—å</button>
        <button id="clearSearch" class="btn">–°–±—Ä–æ—Å</button>
      </div>
    </div>

    <div style="overflow-x: auto;">
      <table id="dataTable">
        <thead><tr><th>–ó–∞–≥—Ä—É–∑–∫–∞...</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <footer>
      üéÖ –û–±–Ω–æ–≤–∏—Ç–µ data.txt –∏ priority.txt –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
    </footer>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const table = document.getElementById('dataTable');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const btnFind = document.getElementById('btnFind');
    const searchPanel = document.getElementById('searchPanel');
    const colSelect = document.getElementById('colSelect');
    const searchInput = document.getElementById('searchInput');
    const doSearchBtn = document.getElementById('doSearch');
    const clearSearchBtn = document.getElementById('clearSearch');

    let headers = [];
    let dataRows = [];
    let priorityColumn = null;

    function showStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (isError ? 'error' : 'success');
    }

    async function fetchText(file) {
      try {
        const res = await fetch(file);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.text();
      } catch (err) {
        throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${file}: ${err.message}`);
      }
    }

    function parseData(text) {
      return text
        .split('\n')
        .map(line => line.trim())
        .filter(line => line && !line.startsWith('#'))
        .map(line => line.split('|').map(s => s.trim()));
    }

    function detectNumericColumn(colIndex, rows) {
      for (let row of rows) {
        if (row.length <= colIndex) return false;
        const val = row[colIndex];
        if (val === '') continue;
        if (isNaN(Number(val))) return false;
      }
      return true;
    }

    function sortRows(rows, colIndex, isNumeric) {
      return [...rows].sort((a, b) => {
        const A = a[colIndex] || '';
        const B = b[colIndex] || '';
        if (isNumeric) {
          return Number(B) - Number(A); // –ø–æ —É–±—ã–≤–∞–Ω–∏—é
        }
        return B.localeCompare(A, 'ru', { numeric: true });
      });
    }

    async function loadData() {
      try {
        showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', false);
        const [dataTxt, priorityTxt] = await Promise.all([
          fetchText('data.txt'),
          fetchText('priority.txt')
        ]);

        const rawData = parseData(dataTxt);
        const priorityLines = priorityTxt.split('\n').map(l => l.trim()).filter(l => l);

        if (priorityLines.length < 1) throw new Error('priority.txt –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω');
        
        headers = priorityLines[0].split('|').map(s => s.trim());

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü
        priorityColumn = null;
        for (let i = 1; i < priorityLines.length; i++) {
          const line = priorityLines[i];
          const match = line.match(/priority\s+for\s+["'](.+?)["']/i);
          if (match) {
            const colName = match[1];
            priorityColumn = headers.indexOf(colName);
            if (priorityColumn === -1) {
              throw new Error(`–°—Ç–æ–ª–±–µ—Ü "${colName}" —É–∫–∞–∑–∞–Ω –≤ priority for, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ`);
            }
            break;
          }
        }

        if (priorityColumn === null) {
          showStatus('‚ö†Ô∏è –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü)', false);
          priorityColumn = headers.length - 1;
        }

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º
        const isNum = detectNumericColumn(priorityColumn, rawData);
        const sortedData = sortRows(rawData, priorityColumn, isNum);

        dataRows = sortedData;
        renderTable();
        showStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${dataRows.length} —Å—Ç—Ä–æ–∫. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: "${headers[priorityColumn]}" (${isNum ? '—á–∏—Å–ª–æ–≤–∞—è' : '—Ç–µ–∫—Å—Ç–æ–≤–∞—è'})`, false);

      } catch (err) {
        showStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, true);
        console.error(err);
      }
    }

    function renderTable() {
      // –ó–∞–≥–æ–ª–æ–≤–∫–∏
      const headerRow = document.createElement('tr');
      headers.forEach((h, i) => {
        const th = document.createElement('th');
        th.textContent = h;
        if (i === priorityColumn) {
          th.style.background = '#ff6f00';
          th.title = '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏';
        }
        headerRow.appendChild(th);
      });
      thead.innerHTML = '';
      thead.appendChild(headerRow);

      // –°—Ç—Ä–æ–∫–∏
      tbody.innerHTML = '';
      dataRows.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach((_, i) => {
          const td = document.createElement('td');
          td.textContent = row[i] || '‚Äî';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—à–∫—É –ø–æ–∏—Å–∫–∞
      colSelect.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
      headers.forEach((h, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = h;
        colSelect.appendChild(opt);
      });
    }

    function highlightSearch(colIndex, query) {
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(tr => tr.classList.remove('highlight'));

      if (colIndex === '' || !query.trim()) return;

      const q = query.trim().toLowerCase();
      let found = 0;
      rows.forEach(tr => {
        const cell = tr.cells[colIndex];
        if (cell && cell.textContent.toLowerCase().includes(q)) {
          tr.classList.add('highlight');
          found++;
        }
      });

      showStatus(`üîç –ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: ${found}`, false);
    }

    // Events
    btnFind.addEventListener('click', () => {
      searchPanel.style.display = searchPanel.style.display === 'none' ? 'block' : 'none';
    });

    doSearchBtn.addEventListener('click', () => {
      const col = colSelect.value;
      const q = searchInput.value;
      highlightSearch(col, q);
    });

    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      colSelect.value = '';
      highlightSearch('', '');
      showStatus('‚úÖ –ü–æ–∏—Å–∫ —Å–±—Ä–æ—à–µ–Ω', false);
    });

    searchInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') doSearchBtn.click();
    });

    // –ó–∞–ø—É—Å–∫
    window.addEventListener('DOMContentLoaded', () => {
      loadData();
      // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ F5 / GitHub Pages CDN –∑–∞–¥–µ—Ä–∂–∫–µ ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
    });
  </script>
</body>
</html>
