<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω—è—è –í–∞–ª—é—Ç–∞</title>
  <style>
    :root {
      --bg: #0a2e47;
      --snow: #f8fbff;
      --gold: #ffd700;
      --green: #2e8b57;
      --red: #d32f2f;
      --border: #4a6b85;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--snow);
      padding: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      overflow-y: scroll; /* üëà –ö–õ–Æ–ß–ï–í–ê–Ø –ü–†–ê–í–ö–ê: –∏–∑–±–µ–≥–∞–µ–º —Å–∫–∞—á–∫–æ–≤ —Å–∫—Ä–æ–ª–ª–∞ */
      position: relative;
      min-height: 100vh;
    }

    /* –°–Ω–µ–∂–∏–Ω–∫–∏ */
    .snowflake {
      position: absolute;
      top: -20px;
      color: white;
      font-size: 1.2rem;
      user-select: none;
      z-index: 1;
      opacity: 0.8;
      animation: fall linear infinite;
    }

    @keyframes fall {
      to {
        transform: translateY(100vh) rotate(360deg);
      }
    }

    /* –û—Å—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∏–ª—å */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 2px solid var(--gold);
      margin-bottom: 20px;
      position: relative;
      z-index: 10;
    }

    h1 {
      font-size: 2.2rem;
      color: var(--gold);
      text-shadow: 0 0 8px rgba(255,215,0,0.4);
    }

    .top-bar {
      display: flex;
      gap: 12px;
    }

    .btn {
      background: var(--green);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn:hover { background: #226b47; }

    .btn-red { background: var(--red); }
    .btn-red:hover { background: #a02525; }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      position: relative;
      z-index: 10;
    }

    .status {
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 6px;
      background: rgba(0,0,0,0.3);
    }
    .status.error { background: rgba(211, 47, 47, 0.2); color: #ffcdd2; }
    .status.success { background: rgba(46, 139, 87, 0.2); }

    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(20, 45, 65, 0.7);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--green);
      color: white;
      position: sticky;
      top: 0;
    }

    tr.highlight {
      background: rgba(255, 215, 0, 0.25) !important;
      animation: pulse 1.5s ease-in-out;
    }

    @keyframes pulse {
      0% { background-color: rgba(255,215,0,0.1); }
      50% { background-color: rgba(255,215,0,0.5); }
      100% { background-color: rgba(255,215,0,0.1); }
    }

    .search-panel {
      margin: 20px 0;
      padding: 16px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      display: none;
    }

    .search-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select, input {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.1);
      color: var(--snow);
    }

    input::placeholder { color: #aaa; }

    footer {
      margin-top: 30px;
      text-align: center;
      font-size: 0.9rem;
      color: #aaa;
      position: relative;
      z-index: 10;
    }

    @media (max-width: 600px) {
      header { flex-direction: column; gap: 10px; }
      .search-row { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div id="snow-container"></div>

  <div class="container">
    <header>
      <h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω—è—è –í–∞–ª—é—Ç–∞</h1>
      <div class="top-bar">
        <a href="https://lichess.org/team/v1TwDg2i" class="btn" target="_blank">–ö–ª—É–±</a>
        <button id="btnFind" class="btn btn-red">–ù–∞–π—Ç–∏ —Å–µ–±—è</button>
      </div>
    </header>

    <div id="status" class="status"></div>

    <div id="searchPanel" class="search-panel">
      <h3>üîç –ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å—å</h3>
      <div class="search-row">
        <label>–°—Ç–æ–ª–±–µ—Ü:</label>
        <select id="colSelect">
          <option value="">‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤‚Ä¶</option>
        </select>
        <label>–¢–µ–∫—Å—Ç:</label>
        <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è, —á–∏—Å–ª–æ –∏ —Ç.–¥." />
        <button id="doSearch" class="btn">–ò—Å–∫–∞—Ç—å</button>
        <button id="clearSearch" class="btn">–°–±—Ä–æ—Å</button>
      </div>
    </div>

    <div style="overflow-x: auto;">
      <table id="dataTable">
        <thead><tr><th>–ó–∞–≥—Ä—É–∑–∫–∞...</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <footer>
      üéÖ –û–±–Ω–æ–≤–∏—Ç–µ data.txt –∏ priority.txt –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
    </footer>
  </div>

  <script>
    // ====== –°–ù–ï–ñ–ò–ù–ö–ò ======
    function createSnowflakes() {
      const container = document.getElementById('snow-container');
      const flakes = '‚ùÖ‚ùÜ‚ùÑ‚úª‚úº‚ùá';
      const count = Math.min(50, Math.floor(window.innerWidth / 20));

      for (let i = 0; i < count; i++) {
        const snow = document.createElement('div');
        snow.className = 'snowflake';
        snow.textContent = flakes[Math.floor(Math.random() * flakes.length)];
        snow.style.left = Math.random() * 100 + 'vw';
        snow.style.opacity = 0.3 + Math.random() * 0.7;
        snow.style.fontSize = (0.8 + Math.random() * 1.2) + 'rem';
        snow.style.animationDuration = (5 + Math.random() * 10) + 's';
        snow.style.animationDelay = Math.random() * 5 + 's';
        container.appendChild(snow);
      }
    }

    // –ó–∞–ø—É—Å–∫ —Å–Ω–µ–∂–∏–Ω–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', createSnowflakes);
    window.addEventListener('resize', () => {
      document.getElementById('snow-container').innerHTML = '';
      createSnowflakes();
    });

    // ====== –û–°–ù–û–í–ù–û–ô –ö–û–î ======
    const statusEl = document.getElementById('status');
    const table = document.getElementById('dataTable');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const btnFind = document.getElementById('btnFind');
    const searchPanel = document.getElementById('searchPanel');
    const colSelect = document.getElementById('colSelect');
    const searchInput = document.getElementById('searchInput');
    const doSearchBtn = document.getElementById('doSearch');
    const clearSearchBtn = document.getElementById('clearSearch');

    let headers = [];
    let dataRows = [];
    let priorityColumn = null;
    let isDataLoaded = false;

    function showStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (isError ? 'error' : 'success');
    }

    async function fetchText(file) {
      try {
        const res = await fetch(file + '?_=' + Date.now()); // bust cache
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.text();
      } catch (err) {
        throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${file}: ${err.message}`);
      }
    }

    function parseData(text) {
      return text
        .split('\n')
        .map(line => line.trim())
        .filter(line => line && !line.startsWith('#'))
        .map(line => line.split('|').map(s => s.trim()));
    }

    function detectNumericColumn(colIndex, rows) {
      for (let row of rows) {
        if (row.length <= colIndex) return false;
        const val = row[colIndex];
        if (val === '') continue;
        if (val !== '' && isNaN(Number(val))) return false;
      }
      return true;
    }

    function sortRows(rows, colIndex, isNumeric) {
      return [...rows].sort((a, b) => {
        const A = a[colIndex] || '';
        const B = b[colIndex] || '';
        if (isNumeric) {
          return Number(B) - Number(A); // –ø–æ —É–±—ã–≤–∞–Ω–∏—é
        }
        return B.localeCompare(A, 'ru', { numeric: true });
      });
    }

    function updateColumnSelect() {
  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º options
  requestAnimationFrame(() => {
    colSelect.innerHTML = '';
    if (headers.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '‚Äî –∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶';
      opt.disabled = true;
      opt.selected = true;
      colSelect.appendChild(opt);
    } else {
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = '‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü ‚Äî';
      colSelect.appendChild(placeholder);
      
      headers.forEach((h, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = h;
        colSelect.appendChild(opt);
      });
    }
  });
}

btnFind.addEventListener('click', async () => {
  // –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
  searchPanel.style.display = searchPanel.style.display === 'none' ? 'block' : 'none';

  // –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –µ—â—ë –Ω–µ –∏–∑–≤–µ—Å—Ç–Ω—ã ‚Äî –≥—Ä—É–∑–∏–º –∏—Ö
  if (headers.length === 0) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–∑–∞–≥—Ä—É–∑–∫–∞" –≤ —Å–µ–ª–µ–∫—Ç–µ
    colSelect.innerHTML = '<option value="" disabled selected>‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã‚Ä¶</option>';
    
    try {
      const priorityTxt = await fetchText('priority.txt');
      const lines = priorityTxt.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('#'));
      
      if (lines.length === 0) throw new Error('–§–∞–π–ª priority.txt –ø—É—Å—Ç');
      
      // –ë–µ—Ä—ë–º –¢–û–õ–¨–ö–û –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏
      headers = lines[0].split('|').map(s => s.trim()).filter(s => s);
      
      if (headers.length === 0) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∑–∞–≥–æ–ª–æ–≤–∫–∏');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç ‚Äî —É–∂–µ —Å –¥–∞–Ω–Ω—ã–º–∏
      updateColumnSelect();
      showStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${headers.length} —Å—Ç–æ–ª–±—Ü–æ–≤: ${headers.join(', ')}`, false);
      
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ priority.txt:', err);
      headers = [];
      updateColumnSelect();
      showStatus(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–æ–ª–±—Ü—ã: ${err.message}`, true);
    }
  } else {
    // –£–∂–µ –µ—Å—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏—Ç—å
    updateColumnSelect();
  }
});

    doSearchBtn.addEventListener('click', () => {
      const col = colSelect.value;
      const q = searchInput.value;
      highlightSearch(col, q);
    });

    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      colSelect.value = '';
      highlightSearch('', '');
      showStatus('‚úÖ –ü–æ–∏—Å–∫ —Å–±—Ä–æ—à–µ–Ω', false);
    });

    searchInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') doSearchBtn.click();
    });

    // –ó–∞–ø—É—Å–∫
    window.addEventListener('DOMContentLoaded', () => {
      loadData();
    });
  </script>
</body>
</html>
