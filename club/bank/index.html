<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω—è—è –í–∞–ª—é—Ç–∞</title>
  <style>
    :root {
      --bg: #0a2e47;
      --snow: #f8fbff;
      --gold: #ffd700;
      --green: #2e8b57;
      --red: #d32f2f;
      --border: #4a6b85;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--snow);
      padding: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      overflow-y: scroll; /* ‚Üê —Ñ–∏–∫—Å –¥—ë—Ä–≥–∞–Ω—å—è —Å–∫—Ä–æ–ª–ª–∞ */
      position: relative;
      min-height: 100vh;
    }

    /* –°–Ω–µ–∂–∏–Ω–∫–∏ */
    #snow-container {
      pointer-events: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }
    .snowflake {
      position: absolute;
      top: -20px;
      color: white;
      font-size: 1.2rem;
      user-select: none;
      opacity: 0.7;
      animation: fall linear forwards;
    }
    @keyframes fall {
      to {
        transform: translateY(100vh) rotate(360deg);
      }
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      position: relative;
      z-index: 10;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 2px solid var(--gold);
      margin-bottom: 20px;
    }

    h1 {
      font-size: 2.2rem;
      color: var(--gold);
      text-shadow: 0 0 8px rgba(255,215,0,0.4);
    }

    .top-bar { display: flex; gap: 12px; }
    .btn {
      background: var(--green);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn:hover { background: #226b47; }
    .btn-red { background: var(--red); }
    .btn-red:hover { background: #a02525; }

    .status {
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 6px;
      background: rgba(0,0,0,0.3);
    }
    .status.error { background: rgba(211, 47, 47, 0.2); color: #ffcdd2; }
    .status.success { background: rgba(46, 139, 87, 0.2); }

    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(20, 45, 65, 0.7);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th {
      background: var(--green);
      color: white;
      position: sticky;
      top: 0;
    }
    tr.highlight {
      background: rgba(255, 215, 0, 0.25) !important;
      animation: pulse 1.5s ease-in-out;
    }
    @keyframes pulse {
      0% { background-color: rgba(255,215,0,0.1); }
      50% { background-color: rgba(255,215,0,0.5); }
      100% { background-color: rgba(255,215,0,0.1); }
    }

    .search-panel {
      margin: 20px 0;
      padding: 16px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      display: none;
    }
    .search-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    select, input {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.1);
      color: var(--snow);
    }
    input::placeholder { color: #aaa; }

    footer {
      margin-top: 30px;
      text-align: center;
      font-size: 0.9rem;
      color: #aaa;
    }

    @media (max-width: 600px) {
      header { flex-direction: column; gap: 10px; }
      .search-row { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div id="snow-container"></div>

  <div class="container">
    <header>
      <h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω—è—è –í–∞–ª—é—Ç–∞</h1>
      <div class="top-bar">
        <a href="https://lichess.org/team/v1TwDg2i" class="btn" target="_blank">–ö–ª—É–±</a>
        <button id="btnFind" class="btn btn-red">–ù–∞–π—Ç–∏ —Å–µ–±—è</button>
      </div>
    </header>

    <div id="status" class="status">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</div>

    <div id="searchPanel" class="search-panel">
      <h3>üîç –ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å—å</h3>
      <div class="search-row">
        <label>–°—Ç–æ–ª–±–µ—Ü:</label>
        <select id="colSelect">
          <option value="">‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤‚Ä¶</option>
        </select>
        <label>–¢–µ–∫—Å—Ç:</label>
        <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è, —á–∏—Å–ª–æ –∏ —Ç.–¥." />
        <button id="doSearch" class="btn">–ò—Å–∫–∞—Ç—å</button>
        <button id="clearSearch" class="btn">–°–±—Ä–æ—Å</button>
      </div>
    </div>

    <div style="overflow-x: auto;">
      <table id="dataTable">
        <thead><tr><th>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <footer>
      üéÖ –û–±–Ω–æ–≤–∏—Ç–µ data.txt –∏ priority.txt –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
    </footer>
  </div>

  <script>
    // ====== –ì–õ–û–ë–ê–õ–´ ======
    const statusEl = document.getElementById('status');
    const table = document.getElementById('dataTable');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const btnFind = document.getElementById('btnFind');
    const searchPanel = document.getElementById('searchPanel');
    const colSelect = document.getElementById('colSelect');
    const searchInput = document.getElementById('searchInput');
    const doSearchBtn = document.getElementById('doSearch');
    const clearSearchBtn = document.getElementById('clearSearch');

    let headers = [];
    let dataRows = []; // –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç: { raw: [...], computed: [...] }
    let priorityColumn = null;
    let isDataLoaded = false;

    // ====== –£–¢–ò–õ–ò–¢–´ ======
    function showStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (isError ? 'error' : 'success');
    }

    async function fetchText(file) {
      const res = await fetch(file + '?_=' + Date.now());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    }

    // –í—ã—á–∏—Å–ª—è–µ—Ç "12+13" ‚Üí 25, –∏–Ω–∞—á–µ NaN ‚Üí –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    function computeExpr(str) {
      if (typeof str !== 'string') return str;
      str = str.trim();
      // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º: 5, 10+2, 3+4+1
      if (/^\d+(\+\d+)*$/.test(str)) {
        try {
          // –ë–ï–ó eval ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ:
          const parts = str.split('+').map(s => parseInt(s, 10));
          if (parts.every(n => !isNaN(n))) {
            return parts.reduce((a, b) => a + b, 0);
          }
        } catch (e) {}
      }
      return NaN;
    }

    function parseData(text) {
      return text
        .split('\n')
        .map(line => line.trim())
        .filter(line => line && !line.startsWith('#'))
        .map(line => {
          const raw = line.split('|').map(s => s.trim());
          const computed = raw.map(cell => {
            const num = computeExpr(cell);
            return isNaN(num) ? cell : num;
          });
          return { raw, computed };
        });
    }

    function detectNumericColumn(colIndex, rows) {
      for (let row of rows) {
        if (row.computed.length <= colIndex) return false;
        const val = row.computed[colIndex];
        if (typeof val !== 'number') return false;
      }
      return true;
    }

    function sortRows(rows, colIndex, isNumeric) {
      return [...rows].sort((a, b) => {
        const A = a.computed[colIndex];
        const B = b.computed[colIndex];
        if (isNumeric) {
          return Number(B) - Number(A); // ‚Üì —É–±—ã–≤–∞–Ω–∏–µ
        }
        const strA = (typeof A === 'string' ? A : String(A)).toLowerCase();
        const strB = (typeof B === 'string' ? B : String(B)).toLowerCase();
        return strB.localeCompare(strA, 'ru', { numeric: true });
      });
    }

    function updateColumnSelect() {
      requestAnimationFrame(() => {
        colSelect.innerHTML = '';
        if (headers.length === 0) {
          colSelect.innerHTML = '<option value="" disabled selected>‚Äî –∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶</option>';
        } else {
          colSelect.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü ‚Äî</option>';
          headers.forEach((h, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = h;
            colSelect.appendChild(opt);
          });
        }
      });
    }

    // ====== –û–°–ù–û–í–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê ======
    async function loadData() {
      try {
        showStatus('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶', false);
        const [dataTxt, priorityTxt] = await Promise.all([
          fetchText('data.txt'),
          fetchText('priority.txt')
        ]);

        const parsedData = parseData(dataTxt);
        const priorityLines = priorityTxt.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('#'));

        if (priorityLines.length < 1) throw new Error('priority.txt –ø—É—Å—Ç');

        headers = priorityLines[0].split('|').map(s => s.trim()).filter(Boolean);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü
        priorityColumn = null;
        for (let line of priorityLines.slice(1)) {
          const match = line.match(/priority\s+for\s+["'](.+?)["']/i);
          if (match) {
            const name = match[1].trim();
            priorityColumn = headers.indexOf(name);
            if (priorityColumn === -1) {
              throw new Error(`–°—Ç–æ–ª–±–µ—Ü "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ä–µ–¥–∏: ${headers.join(', ')}`);
            }
            break;
          }
        }

        if (priorityColumn === null) {
          priorityColumn = headers.length - 1;
          console.warn('‚ö†Ô∏è priority for –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å—Ç–æ–ª–±—Ü—É');
        }

        const isNumeric = detectNumericColumn(priorityColumn, parsedData);
        const sortedData = sortRows(parsedData, priorityColumn, isNumeric);

        dataRows = sortedData;
        isDataLoaded = true;

        // –†–µ–Ω–¥–µ—Ä
        renderTable();
        updateColumnSelect();
        showStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${dataRows.length} —Å—Ç—Ä–æ–∫. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: "${headers[priorityColumn]}" (${isNumeric ? '—á–∏—Å–ª–æ–≤–∞—è' : '—Ç–µ–∫—Å—Ç–æ–≤–∞—è'})`, false);

      } catch (err) {
        console.error(err);
        showStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, true);
        updateColumnSelect();
      }
    }

    function renderTable() {
      // –ó–∞–≥–æ–ª–æ–≤–∫–∏
      thead.innerHTML = '';
      const headerRow = document.createElement('tr');
      headers.forEach((h, i) => {
        const th = document.createElement('th');
        th.textContent = h;
        if (i === priorityColumn) {
          th.style.background = '#ff6f00';
          th.title = '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü';
        }
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      // –°—Ç—Ä–æ–∫–∏
      tbody.innerHTML = '';
      dataRows.forEach(row => {
        const tr = document.createElement('tr');
        row.raw.forEach((cell, i) => {
          const td = document.createElement('td');
          td.textContent = cell;
          // –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å title
          if (typeof row.computed[i] === 'number' && row.computed[i] !== cell) {
            td.title = `–í—ã—á–∏—Å–ª–µ–Ω–æ: ${row.computed[i]}`;
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function highlightSearch(colIndex, query) {
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(tr => tr.classList.remove('highlight'));

      if (colIndex === '' || !query.trim()) return;

      const q = query.trim().toLowerCase();
      let found = 0;
      rows.forEach((tr, idx) => {
        const cell = tr.cells[colIndex];
        const rawVal = dataRows[idx]?.raw[colIndex] || '';
        const compVal = dataRows[idx]?.computed[colIndex];
        const strToSearch = (rawVal + ' ' + (typeof compVal === 'number' ? compVal : '')).toLowerCase();
        if (cell && strToSearch.includes(q)) {
          tr.classList.add('highlight');
          found++;
        }
      });

      showStatus(`üîç –ù–∞–π–¥–µ–Ω–æ: ${found} —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π`, false);
    }

    // ====== –°–û–ó–î–ê–ù–ò–ï –°–ù–ï–ñ–ò–ù–û–ö ======
    function createSnowflakes() {
      const container = document.getElementById('snow-container');
      container.innerHTML = '';
      const flakes = '‚ùÖ‚ùÜ‚ùÑ‚úª‚úº‚ùá';
      const count = Math.min(60, Math.floor(window.innerWidth / 15));

      for (let i = 0; i < count; i++) {
        const snow = document.createElement('div');
        snow.className = 'snowflake';
        snow.textContent = flakes[Math.floor(Math.random() * flakes.length)];
        snow.style.left = Math.random() * 100 + 'vw';
        snow.style.opacity = 0.3 + Math.random() * 0.6;
        snow.style.fontSize = (0.7 + Math.random() * 1) + 'rem';
        snow.style.animationDuration = (6 + Math.random() * 12) + 's';
        snow.style.animationDelay = Math.random() * 5 + 's';
        snow.style.animationName = 'fall';
        container.appendChild(snow);
      }
    }

    // ====== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======
    document.addEventListener('DOMContentLoaded', () => {
      createSnowflakes();
      window.addEventListener('resize', createSnowflakes);

      // –ö–Ω–æ–ø–∫–∞ "–ù–∞–π—Ç–∏ —Å–µ–±—è"
      btnFind.addEventListener('click', async () => {
        searchPanel.style.display = searchPanel.style.display === 'none' ? 'block' : 'none';
        if (headers.length === 0 && !isDataLoaded) {
          colSelect.innerHTML = '<option value="" disabled selected>‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã‚Ä¶</option>';
          try {
            const pt = await fetchText('priority.txt');
            const lines = pt.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('#'));
            if (lines.length >= 1) {
              headers = lines[0].split('|').map(s => s.trim()).filter(Boolean);
              updateColumnSelect();
              showStatus(`‚úÖ –°—Ç–æ–ª–±—Ü—ã: ${headers.join(', ')}`, false);
            }
          } catch (e) {
            headers = [];
            updateColumnSelect();
            showStatus(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏`, true);
          }
        } else {
          updateColumnSelect();
        }
      });

      doSearchBtn.addEventListener('click', () => {
        highlightSearch(colSelect.value, searchInput.value);
      });

      clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        colSelect.value = '';
        highlightSearch('', '');
        showStatus('‚úÖ –ü–æ–∏—Å–∫ —Å–±—Ä–æ—à–µ–Ω', false);
      });

      searchInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') doSearchBtn.click();
      });

      // –ó–ê–ü–£–°–ö –ó–ê–ì–†–£–ó–ö–ò ‚Äî —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å, –ø–æ—Å–ª–µ –≤—Å–µ—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π
      loadData();
    });
  </script>
</body>
</html>
